import { Command } from 'commander';
import chalk from 'chalk';
import ora from 'ora';
import { existsSync, readFileSync, writeFileSync, mkdirSync, readdirSync } from 'fs';
import { resolve, join, relative, dirname } from 'path';
import { loadConfig, getStrings, escapeHtml, extractFrontmatter } from '@codedocs/core';
import type { Locale } from '@codedocs/core';
import { getCliStrings, t, initLocale } from '../i18n.js';
import { Marked } from 'marked';
import { runSubprocess } from '../utils/run-subprocess.js';

export const buildCommand = new Command('build')
  .description('Build production-ready documentation site')
  .option('-c, --config <path>', 'Path to config file', 'codedocs.config.ts')
  .option('--skip-analyze', 'Skip analysis step')
  .option('--skip-generate', 'Skip generation step')
  .option('--verbose', 'Show detailed build output')
  .option('--docs-dir <path>', 'Input docs directory', './docs-output')
  .option('-o, --output <path>', 'Output directory for built site', './dist')
  .action(async (options) => {
    const s = getCliStrings().cli;
    console.log(chalk.bold.cyan(`\nüèóÔ∏è  ${s.buildTitle}\n`));

    try {
      // Load config
      const configPath = resolve(process.cwd(), options.config);
      if (!existsSync(configPath)) {
        console.error(chalk.red(`${s.configNotFound}: ${options.config}\n`));
        process.exit(1);
      }

      const config = await loadConfig(configPath);
      initLocale(config.docs?.locale);
      const strings = getCliStrings().cli;
      const outDir = options.output;

      // Step 1: Analyze
      if (!options.skipAnalyze) {
        await runSubprocess('analyze', ['analyze', '-c', options.config], { verbose: options.verbose });
      } else {
        console.log(chalk.dim(`‚äò ${strings.skippingAnalysis}\n`));
      }

      // Step 2: Generate
      if (!options.skipGenerate) {
        await runSubprocess('generate', ['generate', '-c', options.config], { verbose: options.verbose });
      } else {
        console.log(chalk.dim(`‚äò ${strings.skippingGeneration}\n`));
      }

      // Step 3: Build static HTML site
      console.log(chalk.cyan(strings.buildingSite));
      const spinner = ora(strings.buildingSite).start();
      await buildStaticSite(options.docsDir, outDir, config);
      spinner.succeed(strings.buildComplete);

      // Summary
      console.log(chalk.green(`\n‚úì ${strings.buildComplete}\n`));
      console.log(chalk.dim(`  ${t(strings.outputDirectory, { dir: outDir })}`));
      console.log(chalk.cyan(`\n${strings.nextSteps}`));
      console.log(chalk.dim(`  - ${t(strings.deployHint, { dir: outDir })}`));
      console.log(chalk.dim(`  - ${strings.previewLocalHint}\n`));
    } catch (error) {
      console.error(chalk.red(`\n‚úó ${getCliStrings().cli.buildFailed}\n`));
      console.error(chalk.red((error as Error).message));
      process.exit(1);
    }
  });

async function buildStaticSite(docsDir: string, outDir: string, config: any): Promise<void> {
  const docsPath = resolve(process.cwd(), docsDir);
  const distPath = resolve(process.cwd(), outDir);

  if (!existsSync(docsPath)) {
    throw new Error(`Documentation directory not found: ${docsDir}. Run "codedocs generate" first.`);
  }

  // Create dist directory
  if (!existsSync(distPath)) {
    mkdirSync(distPath, { recursive: true });
  }

  // Collect all markdown files
  const mdFiles = collectMarkdownFiles(docsPath);

  if (mdFiles.length === 0) {
    throw new Error(`No markdown files found in ${docsDir}`);
  }

  // Get locale strings
  const locale = (config.docs?.locale || 'en') as Locale;
  const s = getStrings(locale);

  // Parse markdown files and build navigation
  const pages = mdFiles.map(filePath => {
    const raw = readFileSync(filePath, 'utf-8');
    const { meta, body } = extractFrontmatter(raw);
    const relPath = relative(docsPath, filePath);
    const slug = relPath.replace(/\.md$/, '');
    const title = meta.title || slug.split('/').pop() || 'Untitled';
    const position = meta.sidebar_position ? Number(meta.sidebar_position) : 999;
    return { filePath, relPath, slug, title, body, meta, position };
  });

  // Sort pages by sidebar position
  pages.sort((a, b) => a.position - b.position);

  // Load sidebar structure from _sidebar.json (generated by SidebarGenerator)
  const sidebarJsonPath = join(docsPath, '_sidebar.json');
  const sidebarStructure = existsSync(sidebarJsonPath)
    ? JSON.parse(readFileSync(sidebarJsonPath, 'utf-8'))
    : null;

  // Initialize marked with custom renderer for mermaid
  const marked = new Marked({
    renderer: {
      code(token) {
        if (token.lang === 'mermaid') {
          const encoded = Buffer.from(token.text, 'utf-8').toString('base64');
          return `<div class="mermaid-wrapper"><div class="mermaid-toolbar"><button class="mermaid-copy-btn" data-source="${encoded}" title="Copy code"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button><button class="mermaid-expand-btn" data-source="${encoded}" title="Expand"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg></button></div><div class="mermaid">${token.text}</div></div>`;
        }
        return `<pre><code class="language-${token.lang || ''}">${escapeHtml(token.text)}</code></pre>`;
      }
    }
  });

  // Get project name from config
  const projectName = config.name || config.docs?.title || 'Documentation';

  // Collect all known slugs for link rewriting
  const knownSlugs = new Set(pages.map(p => p.slug));

  // Generate HTML for each page
  for (const page of pages) {
    const htmlContent = await marked.parse(page.body);
    // Rewrite internal .md links to .html and fix directory links
    const rewrittenContent = rewriteInternalLinks(htmlContent, knownSlugs);
    const sanitizedContent = rewrittenContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '').replace(/\bon\w+\s*=/gi, 'data-removed-handler=');
    const contentWithIds = addHeadingIds(sanitizedContent);
    const tocHeadings = extractTocHeadings(contentWithIds);
    const basePrefix = getRelativePrefix(page.slug);
    const navItems = sidebarStructure
      ? buildTopNav(sidebarStructure, basePrefix, page.slug)
      : pages.map(p => ({ label: p.title, href: `${basePrefix}${p.slug}.html`, active: p.slug === page.slug }));
    const htmlPage = generateHtmlPage({
      title: page.title,
      projectName,
      content: contentWithIds,
      navItems,
      tocHeadings,
      currentSlug: page.slug,
      pageId: page.slug,
      locale,
      s,
      basePrefix,
    });

    const outFile = join(distPath, `${page.slug}.html`);
    const outFileDir = dirname(outFile);
    if (!existsSync(outFileDir)) {
      mkdirSync(outFileDir, { recursive: true });
    }
    writeFileSync(outFile, htmlPage, 'utf-8');
  }

  // Generate index.html that redirects to the index page or first page
  const indexPage = pages.find(p => p.slug === 'index') || pages[0];
  if (indexPage && indexPage.slug !== 'index') {
    // Create redirect index.html
    writeFileSync(
      join(distPath, 'index.html'),
      `<!DOCTYPE html><meta http-equiv="refresh" content="0;url=./${indexPage.slug}.html">`,
      'utf-8'
    );
  }

  // Write CSS file
  const assetsDir = join(distPath, 'assets');
  if (!existsSync(assetsDir)) {
    mkdirSync(assetsDir, { recursive: true });
  }
  writeFileSync(join(assetsDir, 'style.css'), getStylesheet(), 'utf-8');
}

function collectMarkdownFiles(dir: string): string[] {
  const files: string[] = [];
  const entries = readdirSync(dir, { withFileTypes: true });
  for (const entry of entries) {
    const fullPath = join(dir, entry.name);
    if (entry.isDirectory()) {
      files.push(...collectMarkdownFiles(fullPath));
    } else if (entry.name.endsWith('.md')) {
      files.push(fullPath);
    }
  }
  return files;
}

function getRelativePrefix(slug: string): string {
  const depth = (slug.match(/\//g) || []).length;
  return depth === 0 ? './' : '../'.repeat(depth);
}

// ‚îÄ‚îÄ Navigation / TOC types and helpers ‚îÄ‚îÄ

interface NavItem {
  label: string;
  href: string;
  active: boolean;
  children?: NavItem[];
}

interface TocHeading {
  id: string;
  text: string;
  level: number;
}

function buildTopNav(items: any[], basePrefix: string, currentSlug: string): NavItem[] {
  const navItems: NavItem[] = [];
  for (const item of items) {
    if (item.type === 'category' && item.items) {
      const children: NavItem[] = item.items.map((child: any) => ({
        label: child.label,
        href: `${basePrefix}${child.id}.html`,
        active: child.id === currentSlug,
      }));
      const isActive = children.some(c => c.active);
      if (children.length === 1) {
        navItems.push({ label: item.label, href: children[0].href, active: isActive });
      } else {
        navItems.push({ label: item.label, href: children[0].href, active: isActive, children });
      }
    } else {
      navItems.push({
        label: item.label,
        href: `${basePrefix}${item.id}.html`,
        active: item.id === currentSlug,
      });
    }
  }
  return navItems;
}

function addHeadingIds(html: string): string {
  const usedIds = new Set<string>();
  return html.replace(/<(h[23])>(.*?)<\/\1>/g, (_match, tag, text) => {
    const plainText = text.replace(/<[^>]+>/g, '').trim();
    let id = plainText
      .toLowerCase()
      .replace(/[^\w\s-\u3131-\uD79D]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-');
    if (!id) id = 'heading';
    let uniqueId = id;
    let counter = 1;
    while (usedIds.has(uniqueId)) {
      uniqueId = `${id}-${counter++}`;
    }
    usedIds.add(uniqueId);
    return `<${tag} id="${uniqueId}">${text}</${tag}>`;
  });
}

function extractTocHeadings(html: string): TocHeading[] {
  const headings: TocHeading[] = [];
  const regex = /<(h[23])\s+id="([^"]*)">(.*?)<\/\1>/g;
  let match;
  while ((match = regex.exec(html)) !== null) {
    const level = parseInt(match[1].charAt(1));
    const id = match[2];
    const text = match[3].replace(/<[^>]+>/g, '').trim();
    headings.push({ id, text, level });
  }
  return headings;
}

function buildNavHtml(navItems: NavItem[]): string {
  return navItems.map(item => {
    if (item.children) {
      const childLinks = item.children.map(child =>
        `<li><a href="${child.href}" class="dropdown-item${child.active ? ' active' : ''}">${escapeHtml(child.label)}</a></li>`
      ).join('\n');
      return `<li class="top-nav-item has-dropdown">
          <button class="top-nav-link${item.active ? ' active' : ''}">${escapeHtml(item.label)} <span class="dropdown-arrow"></span></button>
          <ul class="dropdown-menu">${childLinks}</ul>
        </li>`;
    }
    return `<li class="top-nav-item"><a href="${item.href}" class="top-nav-link${item.active ? ' active' : ''}">${escapeHtml(item.label)}</a></li>`;
  }).join('\n');
}

function buildTocHtml(headings: TocHeading[], s: any): string {
  if (headings.length === 0) return '';
  const items = headings.map(h =>
    `<li class="toc-item toc-h${h.level}"><a href="#${escapeHtml(h.id)}">${escapeHtml(h.text)}</a></li>`
  ).join('\n');
  return `<aside class="toc-sidebar">
    <div class="toc-container">
      <div class="toc-title">${escapeHtml(s.toc.onThisPage)}</div>
      <ul class="toc-list">${items}</ul>
    </div>
  </aside>`;
}

function rewriteInternalLinks(html: string, knownSlugs: Set<string>): string {
  // Rewrite internal .md links to .html (skip external URLs)
  let result = html.replace(/href="([^"]*?)\.md(#[^"]*)?"/g, (match, path, hash) => {
    if (/^(https?:)?\/\//.test(path)) return match;
    return `href="${path}.html${hash || ''}"`;
  });
  // Rewrite directory links (./api/, ./entities/) to directory index.html
  result = result.replace(/href="(\.\/)([a-zA-Z0-9_-]+)\/"/g, (_match, prefix, dir) => {
    if (knownSlugs.has(`${dir}/index`)) {
      return `href="${prefix}${dir}/index.html"`;
    }
    // Fallback: link to first page in that directory
    for (const slug of knownSlugs) {
      if (slug.startsWith(`${dir}/`)) {
        return `href="${prefix}${slug}.html"`;
      }
    }
    return `href="${prefix}${dir}/index.html"`;
  });
  return result;
}

function generateHtmlPage(opts: {
  title: string;
  projectName: string;
  content: string;
  navItems: NavItem[];
  tocHeadings: TocHeading[];
  currentSlug: string;
  pageId: string;
  locale: string;
  s: any;
  basePrefix: string;
}): string {
  const navHtml = buildNavHtml(opts.navItems);
  const tocHtml = buildTocHtml(opts.tocHeadings, opts.s);

  return `<!DOCTYPE html>
<html lang="${opts.locale}" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(opts.title)} - ${escapeHtml(opts.projectName)}</title>
  <link rel="stylesheet" href="${opts.basePrefix}assets/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github.min.css" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true, theme: 'default' });
  </script>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a href="${opts.basePrefix}index.html" class="logo">${escapeHtml(opts.projectName)}</a>
      <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <nav class="top-nav" id="topNav">
        <ul class="top-nav-list">
          ${navHtml}
        </ul>
      </nav>
      <div class="header-actions">
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
          <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
          <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
      </div>
    </div>
  </header>
  <div class="layout">
    <main class="content">
      <article>
        ${opts.content}
      </article>
      <footer class="footer">
        <p>Generated by <a href="https://github.com/jay05410/codedocs">CodeDocs</a></p>
      </footer>
    </main>
    ${tocHtml}
  </div>

  <!-- Memo: floating button -->
  <button class="codedocs-memo-button" id="memoToggleBtn" aria-label="${escapeHtml(opts.s.memo.title)}">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" fill="currentColor"/>
    </svg>
    <span class="codedocs-memo-badge" id="memoBadge" style="display:none">0</span>
  </button>

  <!-- Memo: panel -->
  <div class="codedocs-memo-panel" id="memoPanel" style="display:none">
    <div class="codedocs-memo-panel-header">
      <h3>${escapeHtml(opts.s.memo.title)}</h3>
      <button class="codedocs-memo-close" id="memoCloseBtn" aria-label="Close">&times;</button>
    </div>
    <div class="codedocs-memo-panel-content">
      <div class="codedocs-memo-actions">
        <button class="codedocs-memo-action-btn" id="memoExportBtn">${escapeHtml(opts.s.memo.exportAll)}</button>
        <button class="codedocs-memo-action-btn" id="memoImportBtn">${escapeHtml(opts.s.memo.import)}</button>
        <input type="file" id="memoFileInput" accept=".json" style="display:none" aria-label="${escapeHtml(opts.s.memo.importFile)}">
      </div>
      <div class="codedocs-memo-editor">
        <textarea class="codedocs-memo-textarea" id="memoTextarea" placeholder="${escapeHtml(opts.s.memo.placeholder)}" rows="4" aria-label="${escapeHtml(opts.s.memo.editorLabel)}"></textarea>
        <button class="codedocs-memo-save-btn" id="memoSaveBtn" disabled>${escapeHtml(opts.s.memo.saveMemo)}</button>
      </div>
      <div class="codedocs-memo-list" id="memoList"></div>
    </div>
  </div>

  <!-- Memo: right-click context menu -->
  <div class="codedocs-context-menu" id="memoContextMenu" style="display:none">
    <div class="codedocs-context-menu-item" id="memoContextAdd">${escapeHtml(opts.s.memo.contextAddMemo)}</div>
  </div>

  <script>
    // Theme toggle
    function toggleTheme() {
      var html = document.documentElement;
      var current = html.getAttribute('data-theme');
      var next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      localStorage.setItem('codedocs-theme', next);
    }
    (function() {
      var saved = localStorage.getItem('codedocs-theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();

    // Mobile menu toggle
    document.getElementById('mobileMenuToggle').addEventListener('click', function() {
      document.getElementById('topNav').classList.toggle('open');
    });

    // Top nav dropdowns
    document.querySelectorAll('.has-dropdown').forEach(function(item) {
      var btn = item.querySelector('.top-nav-link');
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var isOpen = item.classList.contains('open');
        document.querySelectorAll('.has-dropdown.open').forEach(function(el) { el.classList.remove('open'); });
        if (!isOpen) item.classList.add('open');
      });
    });
    document.addEventListener('click', function() {
      document.querySelectorAll('.has-dropdown.open').forEach(function(el) { el.classList.remove('open'); });
    });

    // TOC scroll spy
    (function() {
      var tocLinks = document.querySelectorAll('.toc-item a');
      var headings = [];
      tocLinks.forEach(function(link) {
        var id = link.getAttribute('href');
        if (!id) return;
        var el = document.getElementById(id.slice(1));
        if (el) headings.push({ el: el, link: link });
      });
      if (headings.length === 0) return;
      function onScroll() {
        var scrollTop = window.scrollY + 100;
        var active = null;
        for (var i = headings.length - 1; i >= 0; i--) {
          if (headings[i].el.offsetTop <= scrollTop) {
            active = headings[i];
            break;
          }
        }
        tocLinks.forEach(function(l) { l.parentElement.classList.remove('active'); });
        if (active) active.link.parentElement.classList.add('active');
      }
      window.addEventListener('scroll', onScroll, { passive: true });
      onScroll();
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
  <script>
    hljs.highlightAll();
    var observer = new MutationObserver(function() {
      document.querySelectorAll('link[href*="highlight"]').forEach(function(link) {
        if (link.media.includes('light')) {
          link.media = document.documentElement.dataset.theme === 'dark' ? 'not all' : 'all';
        } else {
          link.media = document.documentElement.dataset.theme === 'dark' ? 'all' : 'not all';
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

    // Mermaid copy buttons
    document.querySelectorAll('.mermaid-copy-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var src = atob(btn.dataset.source);
        navigator.clipboard.writeText(src).then(function() {
          var orig = btn.innerHTML;
          btn.innerHTML = '<span class="mermaid-copied">Copied!</span>';
          btn.classList.add('copied');
          setTimeout(function() { btn.innerHTML = orig; btn.classList.remove('copied'); }, 1500);
        }).catch(function() {});
      });
    });

    // Mermaid expand buttons
    document.querySelectorAll('.mermaid-expand-btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var wrapper = btn.closest('.mermaid-wrapper');
        var svgEl = wrapper.querySelector('.mermaid svg');
        if (!svgEl) return;
        var svgMarkup = svgEl.outerHTML;
        var overlay = document.createElement('div');
        overlay.className = 'mermaid-overlay';
        var zoom = 100;
        overlay.innerHTML =
          '<div class="mermaid-popup">' +
            '<div class="mermaid-popup-header">' +
              '<div class="mermaid-zoom-controls">' +
                '<button class="mermaid-zoom-btn" data-action="out">-</button>' +
                '<span class="mermaid-zoom-level">' + zoom + '%</span>' +
                '<button class="mermaid-zoom-btn" data-action="in">+</button>' +
              '</div>' +
              '<button class="mermaid-close-btn" title="Close">' +
                '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>' +
              '</button>' +
            '</div>' +
            '<div class="mermaid-popup-body">' +
              '<div class="mermaid-popup-content" style="transform:scale(1)">' + svgMarkup + '</div>' +
            '</div>' +
          '</div>';
        document.body.appendChild(overlay);
        requestAnimationFrame(function() { overlay.classList.add('active'); });
        var content = overlay.querySelector('.mermaid-popup-content');
        var levelEl = overlay.querySelector('.mermaid-zoom-level');
        var popupSvg = content.querySelector('svg');
        if (popupSvg) { popupSvg.style.maxWidth = 'none'; popupSvg.style.maxHeight = 'none'; }
        overlay.querySelector('[data-action="in"]').addEventListener('click', function() {
          zoom = Math.min(zoom + 10, 200);
          content.style.transform = 'scale(' + (zoom / 100) + ')';
          levelEl.textContent = zoom + '%';
        });
        overlay.querySelector('[data-action="out"]').addEventListener('click', function() {
          zoom = Math.max(zoom - 10, 10);
          content.style.transform = 'scale(' + (zoom / 100) + ')';
          levelEl.textContent = zoom + '%';
        });
        var closePopup = function() {
          overlay.classList.remove('active');
          setTimeout(function() { overlay.remove(); }, 200);
        };
        overlay.querySelector('.mermaid-close-btn').addEventListener('click', closePopup);
        overlay.addEventListener('click', function(ev) { if (ev.target === overlay) closePopup(); });
        document.addEventListener('keydown', function esc(ev) {
          if (ev.key === 'Escape') { closePopup(); document.removeEventListener('keydown', esc); }
        });
      });
    });
  </script>
  <script>
    // Memo System (i18n)
    (function() {
      var PAGE_ID = ${JSON.stringify(opts.pageId)};
      var STORAGE_PREFIX = 'codedocs-memos-';
      var AUTHOR_KEY = 'codedocs-memo-author';
      var STRINGS = ${JSON.stringify(opts.s.memo)};

      var toggleBtn = document.getElementById('memoToggleBtn');
      var badge = document.getElementById('memoBadge');
      var panel = document.getElementById('memoPanel');
      var closeBtn = document.getElementById('memoCloseBtn');
      var textarea = document.getElementById('memoTextarea');
      var saveBtn = document.getElementById('memoSaveBtn');
      var memoList = document.getElementById('memoList');
      var exportBtn = document.getElementById('memoExportBtn');
      var importBtn = document.getElementById('memoImportBtn');
      var fileInput = document.getElementById('memoFileInput');
      var contextMenu = document.getElementById('memoContextMenu');
      var contextAdd = document.getElementById('memoContextAdd');
      var selectedQuote = '';

      function getAuthor() {
        try { return localStorage.getItem(AUTHOR_KEY) || ''; } catch(e) { return ''; }
      }
      function promptAuthor() {
        var existing = getAuthor();
        if (existing) return existing;
        var name = (window.prompt(STRINGS.enterName) || '').trim() || 'Anonymous';
        try { localStorage.setItem(AUTHOR_KEY, name); } catch(e) {}
        return name;
      }
      function loadMemos(pageId) {
        try {
          var stored = localStorage.getItem(STORAGE_PREFIX + pageId);
          if (!stored) return [];
          var parsed = JSON.parse(stored);
          return Array.isArray(parsed) ? parsed : [];
        } catch(e) { return []; }
      }
      function saveMemos(pageId, memos) {
        try { localStorage.setItem(STORAGE_PREFIX + pageId, JSON.stringify(memos)); } catch(e) {}
      }
      function formatTimestamp(iso) {
        var d = new Date(iso);
        return d.toLocaleString(undefined, { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      }
      function updateBadge() {
        var memos = loadMemos(PAGE_ID);
        if (memos.length > 0) { badge.textContent = memos.length; badge.style.display = 'flex'; }
        else { badge.style.display = 'none'; }
      }
      function renderMemos() {
        var memos = loadMemos(PAGE_ID);
        memos.sort(function(a,b) { return new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime(); });
        memoList.innerHTML = '';
        if (memos.length === 0) {
          memoList.innerHTML = '<div class="codedocs-memo-empty">' + STRINGS.noMemos + '</div>';
          updateBadge();
          return;
        }
        memos.forEach(function(memo) {
          var item = document.createElement('div');
          item.className = 'codedocs-memo-item';
          var header = document.createElement('div');
          header.className = 'codedocs-memo-item-header';
          var meta = document.createElement('div');
          meta.className = 'codedocs-memo-item-meta';
          var author = document.createElement('span');
          author.className = 'codedocs-memo-author';
          author.textContent = memo.author || 'Anonymous';
          var ts = document.createElement('span');
          ts.className = 'codedocs-memo-timestamp';
          ts.textContent = formatTimestamp(memo.createdAt);
          meta.appendChild(author);
          meta.appendChild(ts);
          header.appendChild(meta);
          var delBtn = document.createElement('button');
          delBtn.className = 'codedocs-memo-delete-btn';
          delBtn.innerHTML = '&times;';
          delBtn.setAttribute('aria-label', STRINGS.deleteMemo);
          delBtn.addEventListener('click', function() { deleteMemo(memo.id); });
          header.appendChild(delBtn);
          var text = document.createElement('div');
          text.className = 'codedocs-memo-text';
          text.textContent = memo.text;
          item.appendChild(header);
          item.appendChild(text);
          memoList.appendChild(item);
        });
        updateBadge();
      }
      function addMemo(text) {
        if (!text.trim()) return;
        var author = promptAuthor();
        var memo = {
          id: 'memo-' + Date.now() + '-' + Math.random().toString(36).slice(2, 11),
          pageId: PAGE_ID, text: text.trim(), author: author,
          createdAt: new Date().toISOString()
        };
        var memos = loadMemos(PAGE_ID);
        memos.push(memo);
        saveMemos(PAGE_ID, memos);
        renderMemos();
        textarea.value = '';
        saveBtn.disabled = true;
      }
      function deleteMemo(id) {
        var memos = loadMemos(PAGE_ID).filter(function(m) { return m.id !== id; });
        saveMemos(PAGE_ID, memos);
        renderMemos();
      }
      function exportAllMemos() {
        var store = { version: 1, memos: {} };
        try {
          for (var i = 0; i < localStorage.length; i++) {
            var key = localStorage.key(i);
            if (!key || key.indexOf(STORAGE_PREFIX) !== 0) continue;
            var pid = key.slice(STORAGE_PREFIX.length);
            var raw = localStorage.getItem(key);
            if (!raw) continue;
            try { var parsed = JSON.parse(raw); if (Array.isArray(parsed) && parsed.length > 0) store.memos[pid] = parsed; } catch(e) {}
          }
        } catch(e) {}
        var blob = new Blob([JSON.stringify(store, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href = url; a.download = 'memos.json'; a.click();
        URL.revokeObjectURL(url);
      }
      function importMemos(file) {
        var reader = new FileReader();
        reader.onload = function() {
          try {
            var imported = JSON.parse(reader.result);
            if (!imported || !imported.memos) return;
            for (var pageId in imported.memos) {
              var newMemos = imported.memos[pageId];
              if (!Array.isArray(newMemos)) continue;
              var existing = loadMemos(pageId);
              var existingIds = {};
              existing.forEach(function(m) { existingIds[m.id] = true; });
              var added = newMemos.filter(function(m) { return !existingIds[m.id]; });
              if (added.length > 0) saveMemos(pageId, existing.concat(added));
            }
            renderMemos();
          } catch(e) { console.error('Failed to import memos:', e); }
        };
        reader.readAsText(file);
      }
      toggleBtn.addEventListener('click', function() {
        var isOpen = panel.style.display !== 'none';
        panel.style.display = isOpen ? 'none' : 'flex';
        if (!isOpen) renderMemos();
      });
      closeBtn.addEventListener('click', function() { panel.style.display = 'none'; });
      textarea.addEventListener('input', function() { saveBtn.disabled = !textarea.value.trim(); });
      saveBtn.addEventListener('click', function() { addMemo(textarea.value); });
      textarea.addEventListener('keydown', function(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') addMemo(textarea.value);
      });
      exportBtn.addEventListener('click', exportAllMemos);
      importBtn.addEventListener('click', function() { fileInput.click(); });
      fileInput.addEventListener('change', function(e) {
        var file = e.target.files && e.target.files[0];
        if (file) importMemos(file);
        e.target.value = '';
      });
      var article = document.querySelector('article');
      if (article) {
        article.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          selectedQuote = (window.getSelection() || '').toString().trim();
          contextMenu.style.display = 'block';
          contextMenu.style.left = e.pageX + 'px';
          contextMenu.style.top = e.pageY + 'px';
        });
      }
      contextAdd.addEventListener('click', function() {
        contextMenu.style.display = 'none';
        panel.style.display = 'flex';
        renderMemos();
        if (selectedQuote) { textarea.value = '> ' + selectedQuote + '\\n\\n'; saveBtn.disabled = false; }
        textarea.focus();
      });
      document.addEventListener('click', function() { contextMenu.style.display = 'none'; });
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          contextMenu.style.display = 'none';
          if (panel.style.display !== 'none' && !textarea.value.trim()) panel.style.display = 'none';
        }
      });
      updateBadge();
    })();
  </script>
</body>
</html>`;
}

function getStylesheet(): string {
  return `
:root, [data-theme="light"] {
  --bg: #ffffff;
  --bg-secondary: #f6f8fa;
  --bg-tertiary: #eef1f5;
  --text: #1a1a2e;
  --text-secondary: #57606a;
  --text-muted: #8b949e;
  --border: #d1d9e0;
  --border-light: #e8ecf0;
  --primary: #0969da;
  --primary-hover: #0550ae;
  --primary-light: #ddf4ff;
  --primary-subtle: #f0f7ff;
  --code-bg: #f6f8fa;
  --header-bg: #ffffff;
  --shadow: 0 1px 2px rgba(31,35,40,0.04), 0 1px 3px rgba(31,35,40,0.08);
  --shadow-md: 0 3px 6px rgba(31,35,40,0.08), 0 2px 4px rgba(31,35,40,0.06);
  --radius: 8px;
  --radius-lg: 12px;
}
[data-theme="dark"] {
  --bg: #0d1117;
  --bg-secondary: #161b22;
  --bg-tertiary: #1c2129;
  --text: #e6edf3;
  --text-secondary: #8b949e;
  --text-muted: #6e7681;
  --border: #30363d;
  --border-light: #21262d;
  --primary: #58a6ff;
  --primary-hover: #79c0ff;
  --primary-light: #0d2746;
  --primary-subtle: #0d1d31;
  --code-bg: #161b22;
  --header-bg: #161b22;
  --shadow: 0 1px 3px rgba(0,0,0,0.2);
  --shadow-md: 0 3px 6px rgba(0,0,0,0.3);
  --radius: 8px;
  --radius-lg: 12px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
  color: var(--text);
  background: var(--bg);
  line-height: 1.7;
  font-size: 16px;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--header-bg);
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  backdrop-filter: blur(8px);
}
.header-inner {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 1.5rem;
  height: 56px;
  display: flex;
  align-items: center;
  gap: 1.5rem;
}
.logo {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--text);
  text-decoration: none;
  letter-spacing: -0.02em;
  white-space: nowrap;
  flex-shrink: 0;
}
.logo:hover { color: var(--primary); }
.header-actions {
  margin-left: auto;
  flex-shrink: 0;
}
.theme-toggle {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 8px;
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  transition: all 0.15s;
}
.theme-toggle:hover { color: var(--text); border-color: var(--text-muted); }
[data-theme="light"] .moon-icon { display: none; }
[data-theme="dark"] .sun-icon { display: none; }

/* ‚îÄ‚îÄ Top Navigation ‚îÄ‚îÄ */
.top-nav {
  flex: 1;
  min-width: 0;
}
.top-nav-list {
  list-style: none;
  display: flex;
  align-items: center;
  gap: 2px;
  flex-wrap: nowrap;
  overflow-x: auto;
  scrollbar-width: none;
}
.top-nav-list::-webkit-scrollbar { display: none; }
.top-nav-item {
  position: relative;
  flex-shrink: 0;
}
.top-nav-link {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: 6px;
  border: none;
  background: none;
  cursor: pointer;
  white-space: nowrap;
  transition: color 0.12s, background 0.12s;
  font-family: inherit;
}
.top-nav-link:hover {
  color: var(--text);
  background: var(--bg-tertiary);
}
.top-nav-link.active {
  color: var(--primary);
  font-weight: 600;
}
.dropdown-arrow {
  display: inline-block;
  width: 0;
  height: 0;
  border-left: 4px solid transparent;
  border-right: 4px solid transparent;
  border-top: 4px solid currentColor;
  margin-left: 2px;
  transition: transform 0.15s;
}
.has-dropdown.open .dropdown-arrow {
  transform: rotate(180deg);
}
.dropdown-menu {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  min-width: 180px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  padding: 4px 0;
  z-index: 200;
  list-style: none;
  margin-top: 4px;
}
.has-dropdown.open .dropdown-menu {
  display: block;
}
.dropdown-item {
  display: block;
  padding: 6px 14px;
  font-size: 0.85rem;
  color: var(--text-secondary);
  text-decoration: none;
  transition: background 0.12s, color 0.12s;
}
.dropdown-item:hover {
  background: var(--bg-tertiary);
  color: var(--text);
}
.dropdown-item.active {
  color: var(--primary);
  font-weight: 600;
  background: var(--primary-subtle);
}

/* ‚îÄ‚îÄ Mobile hamburger ‚îÄ‚îÄ */
.mobile-menu-toggle {
  display: none;
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 4px 6px;
  cursor: pointer;
  color: var(--text-secondary);
  flex-shrink: 0;
}
.mobile-menu-toggle:hover { color: var(--text); border-color: var(--text-muted); }

/* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
.layout {
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  min-height: calc(100vh - 56px);
}
.content {
  flex: 1;
  padding: 2.5rem 3rem;
  max-width: 880px;
  min-width: 0;
}

/* ‚îÄ‚îÄ TOC Sidebar ‚îÄ‚îÄ */
.toc-sidebar {
  width: 220px;
  min-width: 220px;
  padding: 2rem 1rem 2rem 0;
  position: sticky;
  top: 56px;
  height: calc(100vh - 56px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
  flex-shrink: 0;
}
.toc-sidebar::-webkit-scrollbar { width: 4px; }
.toc-sidebar::-webkit-scrollbar-track { background: transparent; }
.toc-sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
.toc-container {
  border-left: 1px solid var(--border-light);
  padding-left: 1rem;
}
.toc-title {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
}
.toc-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.toc-item {
  margin: 0;
}
.toc-item a {
  display: block;
  padding: 3px 0;
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-decoration: none;
  line-height: 1.5;
  transition: color 0.12s;
}
.toc-item a:hover { color: var(--text); }
.toc-item.active a {
  color: var(--primary);
  font-weight: 600;
}
.toc-h3 { padding-left: 0.75rem; }

/* ‚îÄ‚îÄ Article ‚îÄ‚îÄ */
article h1 {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
  letter-spacing: -0.02em;
  line-height: 1.3;
}
article h2 {
  font-size: 1.4rem;
  font-weight: 600;
  margin: 2.5rem 0 0.75rem;
  padding-bottom: 0.3rem;
  border-bottom: 1px solid var(--border-light);
  letter-spacing: -0.01em;
  line-height: 1.4;
}
article h3 { font-size: 1.15rem; font-weight: 600; margin: 1.75rem 0 0.5rem; line-height: 1.4; }
article p { margin: 0.75rem 0; line-height: 1.75; }
article ul, article ol { margin: 0.75rem 0; padding-left: 1.75rem; }
article li { margin: 0.35rem 0; line-height: 1.65; }
article li::marker { color: var(--text-muted); }
article a { color: var(--primary); text-decoration: none; font-weight: 500; }
article a:hover { text-decoration: underline; color: var(--primary-hover); }
article table {
  width: 100%;
  border-collapse: collapse;
  margin: 1.25rem 0;
  font-size: 0.875rem;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
}
article th {
  background: var(--bg-secondary);
  font-weight: 600;
  text-align: left;
  padding: 0.65rem 0.85rem;
  border-bottom: 1px solid var(--border);
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  color: var(--text-secondary);
}
article td {
  padding: 0.55rem 0.85rem;
  border-bottom: 1px solid var(--border-light);
}
article tr:last-child td { border-bottom: none; }
article tr:hover { background: var(--bg-secondary); }
article code {
  background: var(--code-bg);
  padding: 0.15rem 0.4rem;
  border-radius: 4px;
  font-size: 0.85em;
  font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  border: 1px solid var(--border-light);
}
article pre {
  background: var(--code-bg);
  padding: 1rem 1.25rem;
  border-radius: var(--radius);
  overflow-x: auto;
  margin: 1.25rem 0;
  border: 1px solid var(--border);
}
article pre code {
  background: none;
  padding: 0;
  font-size: 0.85rem;
  line-height: 1.65;
  border: none;
}
article blockquote {
  border-left: 3px solid var(--primary);
  padding: 0.75rem 1.25rem;
  margin: 1.25rem 0;
  background: var(--primary-subtle);
  border-radius: 0 var(--radius) var(--radius) 0;
  color: var(--text-secondary);
}
article details {
  margin: 1rem 0;
  padding: 0.75rem 1rem;
  background: var(--bg-secondary);
  border-radius: var(--radius);
  border: 1px solid var(--border-light);
}
article summary {
  cursor: pointer;
  font-weight: 500;
  color: var(--text-secondary);
  font-size: 0.9rem;
}
article summary:hover { color: var(--text); }
article hr { border: none; border-top: 1px solid var(--border-light); margin: 2rem 0; }
article strong { font-weight: 600; }

/* ‚îÄ‚îÄ Mermaid wrapper ‚îÄ‚îÄ */
.mermaid-wrapper {
  position: relative;
  margin: 1.5rem 0;
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 1.25rem;
  background: var(--bg-secondary);
}
.mermaid-wrapper:hover .mermaid-toolbar { opacity: 1; }
.mermaid { text-align: center; }
.mermaid svg { max-width: 100%; height: auto; }
.mermaid-toolbar {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: opacity 0.15s ease;
  z-index: 10;
}
.mermaid-copy-btn, .mermaid-expand-btn {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 5px 7px;
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.12s ease;
  font-size: 0.75rem;
}
.mermaid-copy-btn:hover, .mermaid-expand-btn:hover {
  background: var(--bg-tertiary);
  color: var(--text);
  border-color: var(--text-muted);
}
.mermaid-copy-btn.copied {
  background: var(--primary-subtle);
  color: var(--primary);
  border-color: var(--primary);
}
.mermaid-copied { font-size: 0.75rem; font-weight: 600; padding: 0 2px; }

/* ‚îÄ‚îÄ Mermaid popup overlay ‚îÄ‚îÄ */
.mermaid-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}
.mermaid-overlay.active { opacity: 1; }
.mermaid-popup {
  background: var(--bg);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  width: 90vw;
  height: 85vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.mermaid-popup-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
  flex-shrink: 0;
}
.mermaid-zoom-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}
.mermaid-zoom-btn {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  color: var(--text);
  font-size: 1.1rem;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.12s;
}
.mermaid-zoom-btn:hover { background: var(--bg-tertiary); border-color: var(--text-muted); }
.mermaid-zoom-level {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-secondary);
  min-width: 48px;
  text-align: center;
  font-variant-numeric: tabular-nums;
}
.mermaid-close-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 5px;
  cursor: pointer;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  transition: all 0.12s;
}
.mermaid-close-btn:hover { color: var(--text); background: var(--bg-tertiary); }
.mermaid-popup-body {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
.mermaid-popup-content {
  transform-origin: center center;
  transition: transform 0.15s ease;
}
.mermaid-popup-content svg { max-width: none; max-height: none; }

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.footer {
  margin-top: 3rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border-light);
  color: var(--text-muted);
  font-size: 0.8rem;
}
.footer a { color: var(--text-secondary); text-decoration: none; }
.footer a:hover { color: var(--primary); }

/* ‚îÄ‚îÄ Memo Button ‚îÄ‚îÄ */
.codedocs-memo-button {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary);
  color: white;
  border: none;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: transform 0.2s, box-shadow 0.2s;
  z-index: 100;
}
.codedocs-memo-button:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}
.codedocs-memo-button:active { transform: scale(0.95); }

.codedocs-memo-badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: #ef4444;
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 6px;
  border: 2px solid var(--bg);
}

/* ‚îÄ‚îÄ Memo Panel ‚îÄ‚îÄ */
.codedocs-memo-panel {
  position: fixed;
  bottom: 0;
  right: 0;
  width: 400px;
  max-width: 90vw;
  max-height: 80vh;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  z-index: 200;
  animation: memoSlideUp 0.3s ease-out;
}
@keyframes memoSlideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.codedocs-memo-panel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-secondary);
}
.codedocs-memo-panel-header h3 {
  margin: 0;
  font-size: 1rem;
  font-weight: 600;
}
.codedocs-memo-close {
  background: transparent;
  border: none;
  font-size: 1.5rem;
  color: var(--text-secondary);
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: background 0.2s;
}
.codedocs-memo-close:hover {
  background: var(--bg-tertiary);
  color: var(--text);
}
.codedocs-memo-panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}
.codedocs-memo-actions {
  display: flex;
  gap: 4px;
  margin-bottom: 16px;
}
.codedocs-memo-action-btn {
  flex: 1;
  padding: 4px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-secondary);
  font-size: 0.8rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s, color 0.2s;
}
.codedocs-memo-action-btn:hover {
  background: var(--bg-tertiary);
  border-color: var(--primary);
  color: var(--text);
}
.codedocs-memo-editor { margin-bottom: 16px; }
.codedocs-memo-textarea {
  width: 100%;
  padding: 8px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--bg);
  color: var(--text);
  font-family: inherit;
  font-size: 0.875rem;
  resize: vertical;
  margin-bottom: 8px;
}
.codedocs-memo-textarea:focus {
  outline: none;
  border-color: var(--primary);
}
.codedocs-memo-save-btn {
  width: 100%;
  padding: 8px 16px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: opacity 0.2s;
}
.codedocs-memo-save-btn:hover:not(:disabled) { opacity: 0.9; }
.codedocs-memo-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }

/* ‚îÄ‚îÄ Memo List ‚îÄ‚îÄ */
.codedocs-memo-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.codedocs-memo-empty {
  text-align: center;
  color: var(--text-muted);
  font-size: 0.85rem;
  padding: 1.5rem 0;
}
.codedocs-memo-item {
  padding: 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 6px;
}
.codedocs-memo-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
}
.codedocs-memo-item-meta {
  display: flex;
  align-items: center;
  gap: 4px;
  flex-wrap: wrap;
}
.codedocs-memo-author {
  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text-secondary);
}
.codedocs-memo-timestamp {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.codedocs-memo-delete-btn {
  background: transparent;
  border: none;
  font-size: 1.25rem;
  color: var(--text-secondary);
  cursor: pointer;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  transition: background 0.2s, color 0.2s;
}
.codedocs-memo-delete-btn:hover {
  background: var(--bg-tertiary);
  color: #ef4444;
}
.codedocs-memo-text {
  font-size: 0.875rem;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
}

/* ‚îÄ‚îÄ Context Menu ‚îÄ‚îÄ */
.codedocs-context-menu {
  position: absolute;
  z-index: 9999;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow-md);
  min-width: 160px;
  padding: 4px 0;
}
.codedocs-context-menu-item {
  padding: 8px 16px;
  font-size: 0.875rem;
  color: var(--text);
  cursor: pointer;
  transition: background 0.12s;
}
.codedocs-context-menu-item:hover {
  background: var(--primary-subtle);
  color: var(--primary);
}

/* ‚îÄ‚îÄ Dark mode shadows ‚îÄ‚îÄ */
[data-theme="dark"] .codedocs-memo-button {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
[data-theme="dark"] .codedocs-memo-button:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
}
[data-theme="dark"] .codedocs-memo-panel {
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
}
[data-theme="dark"] .codedocs-context-menu {
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.4);
}

/* ‚îÄ‚îÄ Responsive: hide TOC below 1100px ‚îÄ‚îÄ */
@media (max-width: 1100px) {
  .toc-sidebar { display: none; }
  .content { max-width: 100%; }
}

/* ‚îÄ‚îÄ Responsive: hamburger menu below 768px ‚îÄ‚îÄ */
@media (max-width: 768px) {
  .mobile-menu-toggle { display: flex; }
  .top-nav {
    display: none;
    position: absolute;
    top: 56px;
    left: 0;
    right: 0;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    box-shadow: var(--shadow-md);
    padding: 0.5rem;
    z-index: 99;
  }
  .top-nav.open { display: block; }
  .top-nav-list {
    flex-direction: column;
    align-items: stretch;
  }
  .top-nav-link {
    width: 100%;
    padding: 8px 12px;
  }
  .dropdown-menu {
    position: static;
    box-shadow: none;
    border: none;
    margin-top: 0;
    padding-left: 1rem;
    background: transparent;
  }
  .has-dropdown.open .dropdown-menu { display: block; }
  .content { padding: 1.25rem 1rem; }
  .header-inner { padding: 0 1rem; }
  .toc-sidebar { display: none; }
}
`;
}
